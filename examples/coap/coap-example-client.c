/* * Copyright (c) 2013, Institute for Pervasive Computing, ETH Zurich * All rights reserved. * * Redistribution and use in source and binary forms, with or without * modification, are permitted provided that the following conditions * are met: * 1. Redistributions of source code must retain the above copyright *    notice, this list of conditions and the following disclaimer. * 2. Redistributions in binary form must reproduce the above copyright *    notice, this list of conditions and the following disclaimer in the *    documentation and/or other materials provided with the distribution. * 3. Neither the name of the Institute nor the names of its contributors *    may be used to endorse or promote products derived from this software *    without specific prior written permission. * * THIS SOFTWARE IS PROVIDED BY THE INSTITUTE AND CONTRIBUTORS ``AS IS'' AND * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE * ARE DISCLAIMED.  IN NO EVENT SHALL THE INSTITUTE OR CONTRIBUTORS BE LIABLE * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF * SUCH DAMAGE. * * This file is part of the Contiki operating system. *//** * \file *      Erbium (Er) CoAP client example. * \author *      Matthias Kovatsch <kovatsch@inf.ethz.ch> */#include <stdio.h>#include <stdlib.h>#include <string.h>#include "contiki.h"#include "contiki-net.h"#include "coap-engine.h"#include "coap-blocking-api.h"#include "cbor-web-token.h"#include "cose-encoder.h"#include "ace/dtls_profile_utils.h"#include "sys/energest.h"/* Log configuration */#include "coap-log.h"#define LOG_MODULE "App"#define LOG_LEVEL  LOG_LEVEL_APP/* FIXME: This server address is hard-coded for Cooja and link-local for unconnected border router. */#if WITH_DTLS#define COAP_DTLS_PSK_DEFAULT_IDENTITY "Client_identity"#define COAP_DTLS_PSK_DEFAULT_KEY      "secretPSK"#define AS_SERVER_EP "coaps://[fe80::212:4b00:09df:9096]"#define RS_SERVER_EP "coaps://[fe80::212:4b00:14b5:d8a3]"#define RS_UNSECURE  "coap://[fe80::212:4b00:14b5:d8a3]"#else#define AS_SERVER_EP "coap://[fe80::212:4b00:09df:9096]"#define RS_SERVER_EP "coap://[fe80::212:4b00:14b5:d8a3]"#define RS_UNSECURE  "coap://[fe80::212:4b00:14b5:d8a3]"dtls_channel new_dtls_channel;#endif#define TOGGLE_INTERVAL 40PROCESS(er_example_client, "Erbium Example Client");AUTOSTART_PROCESSES(&er_example_client);static struct etimer et;static coap_endpoint_t as_server_ep;static coap_endpoint_t rs_server_ep;static coap_endpoint_t server_ep;/* Example URIs that can be queried. *///#define NUMBER_OF_URLS 2/* leading and ending slashes only for demo purposes, get cropped automatically when setting the Uri-Path *///char *service_urls[NUMBER_OF_URLS] ={  ".well-known/core","hello" };#define NUMBER_OF_URLS 5char *service_urls[NUMBER_OF_URLS] = {".well-known/core","token", "authz-info", "hello",".well-known/core"};/* #if PLATFORM_HAS_BUTTON */static int uri_switch = 0;/* #endif */uint8_t payload_bytes[1024];uint16_t payload_len;#if ACE_INFOunsigned long transmit_time,transmit_time3,transmit_time4,transmit_time6;unsigned long listen_time,listen_time3,listen_time4,listen_time6;unsigned long lpm_time,lpm_time3,lpm_time4,lpm_time6;unsigned long cpu_time,cpu_time3,cpu_time4,cpu_time6;unsigned long deep_lpm_time,deep_lpm_time3,deep_lpm_time4,deep_lpm_time6;unsigned long total_time,total_time3,total_time4,total_time6;unsigned long radio_off,radio_off3,radio_off4,radio_off6;/*static unsigned longto_seconds(uint64_t time){  return (unsigned long)(time / ENERGEST_SECOND);}*/static uint64_tto_seconds(uint64_t time){  return time;}#endifvoiddecode_token(coap_message_t *response){  const uint8_t *chunk;  int len = coap_get_payload(response, &chunk);  memcpy(&payload_bytes, chunk, len);  printf(">>>>>> payload len ---- %d\n",len);  printf("RS INFORMATION AND ACCESS TOKEN RECEIVED\n");  static uint8_t payload_bytes_cose[2000];  cbor_data cb_data;  cb_data.buf =(uint8_t *)chunk;  cb_data.ptr = 0; #if ACE_INFO  printf("\n................  ACE STATS  .....................\n");  printf("ENERGEST: \n");  printf("0.T_dec_c start\t");  printf("\n....................................................\n");  //  powertrace_print("0.T_dec_c start\t");   cpu_time = energest_type_time(ENERGEST_TYPE_CPU);   lpm_time = energest_type_time(ENERGEST_TYPE_LPM);   deep_lpm_time = energest_type_time(ENERGEST_TYPE_DEEP_LPM);    transmit_time = energest_type_time(ENERGEST_TYPE_TRANSMIT);   listen_time = energest_type_time(ENERGEST_TYPE_LISTEN);   total_time = ENERGEST_GET_TOTAL_TIME();   radio_off = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN);   #endif  payload_len = unwrap_cose_envelope(&cb_data, COSE_ENCRYPT0, payload_bytes_cose, len);  #if ACE_INFO//  powertrace_print("0.T_dec_c stop \t");   cpu_time = energest_type_time(ENERGEST_TYPE_CPU) - cpu_time;   lpm_time = energest_type_time(ENERGEST_TYPE_LPM) - lpm_time;   deep_lpm_time = energest_type_time(ENERGEST_TYPE_DEEP_LPM) - deep_lpm_time;   transmit_time = energest_type_time(ENERGEST_TYPE_TRANSMIT) - transmit_time;   listen_time = energest_type_time(ENERGEST_TYPE_LISTEN) - listen_time;   total_time = ENERGEST_GET_TOTAL_TIME() - total_time;   radio_off = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN) - radio_off;   printf("CPU  %4lld   LPM   %4lld   DEEP LPM   %4lld   TRANSMIT TIME   %4lld    LISTEN_TIME   %4lld\n  TOTAL TIME %4lld  RADIO OFF%4lld\n",                   to_seconds(cpu_time),                  to_seconds(lpm_time),                  to_seconds(deep_lpm_time),                  to_seconds(transmit_time),                  to_seconds(listen_time),                  to_seconds(total_time),                  to_seconds(radio_off)                  );  printf("\n 0.T_dec_c stop \t");  printf("\n....................................................\n");    #endif  payload_len = cb_data.ptr;  // cbor_data cb_data;  cb_data.buf =  payload_bytes_cose;  cb_data.ptr = 0;  static uint8_t claim[950];  //decode_cbor_web_token_dtls(&cb_data);cpu_time4  decode_cbor_web_token(&cb_data, claim, &new_dtls_channel);  printf(">>>>>> len of token ---- %d\n",len);  // payload_len = len;}void process_token_client_handler(coap_message_t *response){ const uint8_t *chunk;  int len = coap_get_payload(response, &chunk);  printf("|%.*s", len, (char *)chunk);  #if WITH_DTLS//#if 0  // received = 1;#if ACE_INFO  #if DISABLE_PRINTF_INSIDEprintf("\n................  ACE STATS  .....................\n");printf("ENERGEST: \n");printf("4.start\t");printf("\n....................................................\n");  #endif     cpu_time4 = energest_type_time(ENERGEST_TYPE_CPU);   lpm_time4 = energest_type_time(ENERGEST_TYPE_LPM);   deep_lpm_time4 = energest_type_time(ENERGEST_TYPE_DEEP_LPM);    transmit_time4 = energest_type_time(ENERGEST_TYPE_TRANSMIT);   listen_time4 = energest_type_time(ENERGEST_TYPE_LISTEN);   total_time4 = ENERGEST_GET_TOTAL_TIME();   radio_off4 = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN); #endif  #if DTLS_PSK process_psk_token_client(&new_dtls_channel); //#if DTLS_ECC//process_rpk_token_client();//#endif#endif #if ACE_INFO  cpu_time4 = energest_type_time(ENERGEST_TYPE_CPU) - cpu_time4;   lpm_time4 = energest_type_time(ENERGEST_TYPE_LPM) - lpm_time4;   deep_lpm_time4 = energest_type_time(ENERGEST_TYPE_DEEP_LPM) - deep_lpm_time4;   transmit_time4 = energest_type_time(ENERGEST_TYPE_TRANSMIT) - transmit_time4;   listen_time4 = energest_type_time(ENERGEST_TYPE_LISTEN) - listen_time4;   total_time4 = ENERGEST_GET_TOTAL_TIME() - total_time4;   radio_off4 = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN) - radio_off4;//#if DISABLE_PRINTF_INSIDE   printf("CPU  %4lld   LPM   %4lld   DEEP LPM   %4lld   TRANSMIT TIME   %4lld    LISTEN_TIME   %4lld\n  TOTAL TIME %4lld  RADIO OFF %4lld\n",                   to_seconds(cpu_time4),                  to_seconds(lpm_time4),                  to_seconds(deep_lpm_time4),                  to_seconds(transmit_time4),                  to_seconds(listen_time4),                  to_seconds(total_time4),                  to_seconds(radio_off4)                  );  printf("4.stop\t");  printf("\n....................................................\n");//  #endif#endif#endif}/* This function is will be passed to COAP_BLOCKING_REQUEST() to handle responses. */voidclient_chunk_handler(coap_message_t *response){  const uint8_t *chunk;  int len = coap_get_payload(response, &chunk);  printf("|%.*s", len, (char *)chunk);}PROCESS_THREAD(er_example_client, ev, data){    PROCESS_BEGIN();  etimer_set(&et, TOGGLE_INTERVAL * CLOCK_SECOND);  static coap_message_t request[1];      /* This way the packet can be treated as pointer as usual. */  coap_endpoint_parse(AS_SERVER_EP, strlen(AS_SERVER_EP), &as_server_ep);   coap_endpoint_parse(RS_UNSECURE, strlen(RS_UNSECURE), &server_ep);#if WITH_DTLS while(!coap_endpoint_is_connected(&as_server_ep)) {    coap_endpoint_connect(&as_server_ep);    etimer_set(&et, CLOCK_SECOND*5);    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&et));  }etimer_set(&et,5*CLOCK_SECOND);#endif  while(1){  PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&et));  etimer_reset(&et);  // sprintf(buf, "H");//Update all energest times.  energest_flush();  // // sprintf(buf, "Hello %d from the client", ++seq_id);  // printf(" (msg: %s)\n", buf);  // uip_udp_packet_send(client_conn, buf, strlen(buf));  // uip_udp_packet_send(client_conn, buf, UIP_APPDATA_SIZE);      while(uri_switch  < NUMBER_OF_URLS) { //Client REQUEST TOKEN to AS        printf("\n--Requesting %s to: ", service_urls[uri_switch]);        if (uri_switch == 0){          printf("--AS--\n");          LOG_INFO("-------------------------\n");          LOG_INFO("REQUESTING INFO FROM AS\n");          LOG_INFO_COAP_EP(&as_server_ep);          LOG_INFO("\n-------------------------\n");          coap_init_message(request, COAP_TYPE_CON, COAP_GET, coap_get_mid());          coap_set_header_uri_path(request, service_urls[uri_switch]);  //Call blocks until response is received ◾ linear program code for interactions ◾ also handles blockwise transfers          COAP_BLOCKING_REQUEST(&as_server_ep, request, client_chunk_handler);        } else if (uri_switch == 1){ //Client receive access token and rs information from AS           printf("--AS--\n");          LOG_INFO_COAP_EP(&as_server_ep);          printf("-------------------------\n");          printf("REQUESTING TOKEN FROM AS\n");          printf("\n-------------------------\n");          #if ACE_INFO            printf("\n................  ACE STATS  .....................\n");            printf("ENERGEST: \n" );            printf("1.start\t");            printf("\n....................................................\n");               cpu_time = energest_type_time(ENERGEST_TYPE_CPU);             lpm_time = energest_type_time(ENERGEST_TYPE_LPM);             deep_lpm_time = energest_type_time(ENERGEST_TYPE_DEEP_LPM);              transmit_time = energest_type_time(ENERGEST_TYPE_TRANSMIT);             listen_time = energest_type_time(ENERGEST_TYPE_LISTEN);             total_time = ENERGEST_GET_TOTAL_TIME();             radio_off = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN);           #endif                              coap_init_message(request, COAP_TYPE_CON, COAP_GET, coap_get_mid());          coap_set_header_uri_path(request, service_urls[uri_switch]);          // received = 0;          // while(!received){          COAP_BLOCKING_REQUEST(&as_server_ep, request, decode_token);          // }          #if ACE_INFO             cpu_time = energest_type_time(ENERGEST_TYPE_CPU) - cpu_time;             lpm_time = energest_type_time(ENERGEST_TYPE_LPM) - lpm_time;             deep_lpm_time = energest_type_time(ENERGEST_TYPE_DEEP_LPM) - deep_lpm_time;             transmit_time = energest_type_time(ENERGEST_TYPE_TRANSMIT) - transmit_time;             listen_time = energest_type_time(ENERGEST_TYPE_LISTEN) - listen_time;             total_time = ENERGEST_GET_TOTAL_TIME() - total_time;             radio_off = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN) - radio_off;             printf("CPU  %4lld   LPM   %4lld   DEEP LPM   %4lld   TRANSMIT TIME   %4lld    LISTEN_TIME   %4lld\n  TOTAL TIME %4lld  RADIO OFF%4lld\n",                   to_seconds(cpu_time),                  to_seconds(lpm_time),                  to_seconds(deep_lpm_time),                  to_seconds(transmit_time),                  to_seconds(listen_time),                  to_seconds(total_time),                  to_seconds(radio_off)                  );  printf("1.stop\t");  printf("\n....................................................\n");          #endif          printf("---------------------------\n");	  coap_endpoint_disconnect(&as_server_ep);        }        else if (uri_switch == 2){ // POST TOKEN to RS/*#if WITH_DTLS coap_endpoint_parse(RS_SERVER_EP, strlen(RS_SERVER_EP), &rs_server_ep); while(!coap_endpoint_is_connected(&rs_server_ep)) {    coap_endpoint_connect(&rs_server_ep);    etimer_set(&et, CLOCK_SECOND*8);    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&et));  }//etimer_set(&et,5*CLOCK_SECOND); #endif*/	                #if ACE_INFO            printf("\n................  ACE STATS  .....................\n");            printf("ENERGEST: \n" );            printf("3.start\t");            printf("\n....................................................\n");              cpu_time3 = energest_type_time(ENERGEST_TYPE_CPU);             lpm_time3 = energest_type_time(ENERGEST_TYPE_LPM);             deep_lpm_time3 = energest_type_time(ENERGEST_TYPE_DEEP_LPM);              transmit_time3 = energest_type_time(ENERGEST_TYPE_TRANSMIT);             listen_time3 = energest_type_time(ENERGEST_TYPE_LISTEN);             total_time3 = ENERGEST_GET_TOTAL_TIME();             radio_off3 = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN);           #endif          #if DISABLE_PRINTF                       printf("--RS--\n");          printf("-------------------------\n");          printf("POSTING TOKEN TO RS\n");          LOG_INFO_COAP_EP(&server_ep);          LOG_INFO("\n-------------------------\n");#endif                    coap_init_message(request, COAP_TYPE_CON, COAP_POST, coap_get_mid());          coap_set_payload(request, &payload_bytes, payload_len);          coap_set_header_uri_path(request, service_urls[uri_switch]);          //COAP_BLOCKING_REQUEST_DO(server_addr, server_port, request, chunk_handler, something_to_do)           //COAP_BLOCKING_REQUEST_DO(&rs_server_ep, request, client_chunk_handler,process_token_client_handler);          COAP_BLOCKING_REQUEST(&server_ep, request,process_token_client_handler);          // #if WITH_CONF_IPSEC_IKE          //     set_spd_rs_null();          // #endif        }      //  #if WITH_DTLS        else if (uri_switch == 3){ //	 #if WITH_DTLS 	coap_endpoint_parse(RS_SERVER_EP, strlen(RS_SERVER_EP), &rs_server_ep);	#endif#if DISABLE_PRINTF          printf("--RS--\n");          printf("-------------------------\n");          printf("REQUESTING FIRST PROTECTED RESOURCE\n");          LOG_INFO_COAP_EP(&rs_server_ep);          printf("\n-------------------------\n");          // set_psk(new_ipsec_sa.psk);#endif          #if ACE_INFO        cpu_time6 = energest_type_time(ENERGEST_TYPE_CPU);    lpm_time6 = energest_type_time(ENERGEST_TYPE_LPM);    deep_lpm_time6 = energest_type_time(ENERGEST_TYPE_DEEP_LPM);     transmit_time6 = energest_type_time(ENERGEST_TYPE_TRANSMIT);    listen_time6 = energest_type_time(ENERGEST_TYPE_LISTEN);    total_time6 = ENERGEST_GET_TOTAL_TIME();    radio_off6 = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN);  #endif #if WITH_DTLS coap_endpoint_parse(RS_SERVER_EP, strlen(RS_SERVER_EP), &rs_server_ep); while(!coap_endpoint_is_connected(&rs_server_ep)) {     coap_endpoint_connect(&rs_server_ep);    etimer_set(&et, CLOCK_SECOND*8);    PROCESS_WAIT_EVENT_UNTIL(etimer_expired(&et));   	  }//etimer_set(&et,5*CLOCK_SECOND); #endif#if ACE_INFO             cpu_time6 = energest_type_time(ENERGEST_TYPE_CPU) - cpu_time6;             lpm_time6 = energest_type_time(ENERGEST_TYPE_LPM) - lpm_time6;             deep_lpm_time6 = energest_type_time(ENERGEST_TYPE_DEEP_LPM) - deep_lpm_time6;             transmit_time6 = energest_type_time(ENERGEST_TYPE_TRANSMIT) - transmit_time6;             listen_time6 = energest_type_time(ENERGEST_TYPE_LISTEN) - listen_time6;             total_time6 = ENERGEST_GET_TOTAL_TIME() - total_time6;             radio_off6 = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN) - radio_off6;             printf("CPU  %4lld   LPM   %4lld   DEEP LPM   %4lld   TRANSMIT TIME   %4lld    LISTEN_TIME   %4lld\n  TOTAL TIME %4lld  RADIO OFF%4lld\n",                   to_seconds(cpu_time6),                  to_seconds(lpm_time6),                  to_seconds(deep_lpm_time6),                  to_seconds(transmit_time6),                  to_seconds(listen_time6),                  to_seconds(total_time6),                  to_seconds(radio_off6)                  );          printf("5. stop\t");          printf("\n....................................................\n");         #endif    	 coap_init_message(request, COAP_TYPE_CON, COAP_GET, coap_get_mid());     	 coap_set_header_uri_path(request, service_urls[uri_switch]);    	 COAP_BLOCKING_REQUEST(&rs_server_ep, request,client_chunk_handler);                // uri_switch = ((uri_switch + 1) % NUMBER_OF_URLS);          #if ACE_INFO             cpu_time3 = energest_type_time(ENERGEST_TYPE_CPU) - cpu_time3;             lpm_time3 = energest_type_time(ENERGEST_TYPE_LPM) - lpm_time3;             deep_lpm_time3 = energest_type_time(ENERGEST_TYPE_DEEP_LPM) - deep_lpm_time3;             transmit_time3 = energest_type_time(ENERGEST_TYPE_TRANSMIT) - transmit_time3;             listen_time3 = energest_type_time(ENERGEST_TYPE_LISTEN) - listen_time3;             total_time3 = ENERGEST_GET_TOTAL_TIME() - total_time3;             radio_off3 = ENERGEST_GET_TOTAL_TIME() - energest_type_time(ENERGEST_TYPE_TRANSMIT) - energest_type_time(ENERGEST_TYPE_LISTEN) - radio_off3;             printf("CPU  %4lld   LPM   %4lld   DEEP LPM   %4lld   TRANSMIT TIME   %4lld    LISTEN_TIME   %4lld\n  TOTAL TIME %4lld  RADIO OFF%4lld\n",                   to_seconds(cpu_time3),                  to_seconds(lpm_time3),                  to_seconds(deep_lpm_time3),                  to_seconds(transmit_time3),                  to_seconds(listen_time3),                  to_seconds(total_time3),                  to_seconds(radio_off3)                  );          printf("3. stop\t");          printf("\n....................................................\n");          #endif              } /*         else if (uri_switch == 4){ //          printf("--RS--\n");          printf("-------------------------\n");          printf("REQUESTING UNPROTECTED RESOURCE\n");          //coap_endpoint_parse(RS_SERVER_EP, strlen(RS_SERVER_EP), &rs_server_ep);          //RES_SERVER_NODE(&rs_ipaddr); // there is a Buffer overflow after receiveing the token          LOG_INFO_COAP_EP(&rs_server_ep);          //PRINT6ADDR(&rs_ipaddr);          printf("\n-------------------------\n");          coap_init_message(request, COAP_TYPE_CON, COAP_GET, coap_get_mid());          coap_set_header_uri_path(request, service_urls[uri_switch]);          COAP_BLOCKING_REQUEST(&rs_server_ep, request, client_chunk_handler);        }      //#endif// } else if (uri_switch > 4){ ////           printf("--RS--\n");//           printf("-------------------------\n");//           printf("REQUESTING PROTECTED RESOURCE\n");//           PRINT6ADDR(&rs_ipaddr);//           printf("\n-------------------------\n");//           coap_init_message(request, COAP_TYPE_CON, COAP_GET, coap_get_mid());//           coap_set_header_uri_path(request, service_urls[uri_switch]);//           COAP_BLOCKING_REQUEST(&rs_ipaddr, REMOTE_PORT, request,//                               client_chunk_handler1);*/            uri_switch = ((uri_switch + 1));    }   }  PROCESS_END();}